---
layout: post
title: "비 최대값 억제"
tags: [Non-max suppression, bounding box]
categories: [Convolutional Neural Networks]
---

# 학습 목표
- 비-최대값 억제를 알아본다.

# 핵심 키워드
- 비 최대값 억제
- 경계 상자

# 학습 내용
- 알고리즘이 같은 물체를 여러번 감지하는 경우도 있을 것입니다. 하지만 우리는 하나의 물체는 한번 감지하기를 원합니다. 이를 비-최대값 억제를 통해서 해결할 수 있습니다.
- 비-최대값 억제는 알고리즘이 각 물체를 한 번식만 감지하게 보장합니다.
- 물체를 감지한 경계상자들 중에서 감지 확률(pc)이 최대인 상자를 고른 후, 해당 경계 상자와의 IOU를 구해서 높은 IOU를 가진 상자들을 제거하는 방법이 비-최대값 억제입니다.
- 구체적으로 하나의 물체를 감지하는 예시를 하나 봅시다.
![image](https://user-images.githubusercontent.com/50114210/71542055-f03b1280-29a4-11ea-82cc-3995baa8198f.png)

- 1. 감지된 모든 경계 상자중, 감지 확률이 0.6 이하인 경계 상자를 버립니다.
- 2. 감지 확률이 제일 높은 경계상자를 기준으로 잡습니다.
- 3. 해당 상자와 높은 IOU를 가지는 경계 상자를 버립니다.
- 4. 1개가 남을때까지 2~3과정을 계속 반복합니다.

- 만약에 2개 이상의 클래스가 있을 경우, 각 클래스에 대해 독립적으로 비-최대값 억제를 해야합니다.

# 인트로
지금까지 여러분이 배운 물체 감지의 문제 중 하나는      
알고리즘이 같은 물체를 여러 번 감지해서      
어떤 물체를 한 번이 아니라 여러 번 감지할 수도 있다는 것입니다      
비-최댓값 억제는 알고리즘이 각 물체를 한 번씩만 감지하게 보장합니다 예시를 봅시다      

# 물체가 있을 확률들
![image](https://user-images.githubusercontent.com/50114210/71542069-32fcea80-29a5-11ea-9990-4e2d869111d1.png)                
이 사진에서 보행자와 자동차 오토바이를 감지하고 싶다고 합시다           
여러분은 아마 이렇게 격자를 놓을 것입니다 이건 19 곱하기 19 격자입니다           
엄밀히 말해서 이 자동차는 하나의 중심점을 가지고 있기 때문에            
하나의 격자 셀만 할당되어야 합니다           
왼쪽 자동차 역시 하나의 중심점을 가지므로           
엄밀히 하나의 셀만이 자동차가 있는 것을 예측해야 합니다           
실제로는 모든 격자 셀에 대해서 물체 분류와 지역화 알고리즘을           
적용하기 때문에 이 격자 셀은 자동차의 중심이 안에 있다고 생각할 수 있고           
이 셀과 이 셀도 그렇고 왼쪽 차도 마찬가지입니다           
만약 이게 여러분이 이전에 보았던 테스트 이미지라면           
이 박스만 자동차를 찾았다고 판단하는 것이 아니라           
이 박스와 이 박스도 자동차를 찾았다고 생각할 수도 있습니다           

# 비최대값 억제
![image](https://user-images.githubusercontent.com/50114210/71542140-10b79c80-29a6-11ea-9705-b141451bdd69.png)            
비-최댓값 억제가 어떻게 작동하는지 예시를 살펴봅시다     
여러분이 이미지 분류와 지역화 알고리즘을 361개의 격자 셀에 모두 적용하기 때문에     
그 중 대다수가 자기 안에 물체가 있을 확률인 Pc가 그냥 361개 격자 셀 중      
두 개를 고르는 것보다 크다고 생각할 가능성이 있습니다     
그래서 여러분이 알고리즘을 적용할 때 각 물체마다 여러 개가 감지될 수도 있습니다     
![image](https://user-images.githubusercontent.com/50114210/71542144-20cf7c00-29a6-11ea-8b23-1632bf6e4dc8.png)                       
비-최댓값 억제가 하는 것은 감지된 것들을 정리하는 것입니다                 
그래서 자동차 하나 당 여러 개가 아닌 하나의 감지만 남게 됩니다                 
구체적으로는 먼저 각 감지의 확률을 살핍니다                 
![image](https://user-images.githubusercontent.com/50114210/71542149-35ac0f80-29a6-11ea-9b74-a6243a1d1f38.png)                         
먼저 가장 큰 값을 고릅니다 이 경우엔 0.9입니다                 
그리고 그걸 가장 자신 있는 감지라고 하고 그곳에서 자동차를 찾았다고 강조해 둡시다                 
![image](https://user-images.githubusercontent.com/50114210/71542171-55433800-29a6-11ea-80a9-fc44c8c741c0.png)                        
그러고 나면 비-최댓값 억제에서 나머지 직사각형들을 검사해서                 
그 직사각형과 많이 겹치는 즉 IOU가 높은 직사각형들을 억제시킵니다                 
여기 0.6과 0.7의 직사각형들은 하늘색 직사각형과 많이 겹치므로                 
이것들이 억제해야 할 대상이 됩니다 억제된 것을 표시하기 위해 어두운 색으로 표시합니다                 
다음으로 나머지 직사각형 중 가장 높은 확률 Pc를 찾습니다                 
이 경우에는 0.8을 가지는 이것입니다 따라서 여기에서 자동차를 감지했다고 표시한 후                 
비-최댓값 억제를 통해 더 높은 IOU를 가진 것을 억제합니다                 
이제 모든 직사각형은 강조되었거나 어둡게 표시되었습니다                 
![image](https://user-images.githubusercontent.com/50114210/71542163-478db280-29a6-11ea-8fa2-d03c4bd2f61a.png)                         
어둡게 표시된 직사각형들을 제거하고 나면 강조된 두 개의 직사각형만 남고                 
이게 최종적인 두 개의 예측입니다 이게 비-최댓값 억제입니다                 
비-최댓값이란 확률의 최댓값을 도출하고 최댓값이 아닌 것들은 억제한다는 의미입니다                 

# 비 최대값 억제 알고리즘
![image](https://user-images.githubusercontent.com/50114210/71542185-773cba80-29a6-11ea-8903-efd3dd76310d.png)               
알고리즘의 세부적인 부분을 살펴봅시다         

### 각 격자에서 확률 도출
먼저 여러분은 이 19x19 격자에서 19x19x8 부피의 결과를 도출하려 합니다         
이 예시에서는 문제를 단순화해서 자동차만 검출하려고 한다고 합시다         
따라서 c1, c2, c3를 제거하고 이 선을 19x19의 각각의 결과라고 합시다         
즉 19의 제곱인 361개의 위치에 대해서 그곳에 물체와 경계 상자가 있는지 예측이 도출됩니다         
만약 하나의 물체밖에 없다면 c1, c2, c3 예측은 없습니다         

### 임계치보다 낮은 상자 버리기
비-최댓값 억제를 구현하기 위해 첫 번째로 할 일은         
어떤 임계값보다 작거나 같은 Pc를 가진 경계 상자들을 모두 버리는 것입니다         
0.6이라고 해봅시다 그 위치에서 물체가 발견될 확률이 적어도 0.6이 되지 않으면         
그냥 제거합니다 따라서 낮은 확률을 가진 모든 결과 상자들이 버려집니다         
361개의 위치 각각에 대해 경계 상자와          
그 경계 상자의 높은 확률을 함께 도출하는 것이라 생각하면 됩니다         
따라서 낮은 확률의 경계 상자는 그냥 모두 버립니다         

### 반복
그런 다음 아직 버려지지 않고 남은 경계 상자가 있다면         
반복적으로 가장 높은 확률 Pc를 가지는 것을 고르고 그것을 예측의 결과로 내놓습니다         
이게 이전 슬라이드에 있었던 경계 상자 중 하나를 골라서 더 밝은 색으로 표시해서         
그곳에 차가 있다는 예측을 도출하는 과정입니다         
그 다음 남아있는 직사각형 중 예측값이 아니거나 이전에 버려지지 않은 것을 버립니다         

### 높은 값을 가지는 상자와 많이 겹치는 상자 버리기
즉 이전 단계에서 도출된 직사각형과 많이 겹쳐서 높은 IOU를 가진 박스들을 버립니다         
while문 안의 이 두 번째 단계는 이전 슬라이드에서 밝은 색으로 강조했던         
경계 상자와 많이 겹치는 것을 어둡게 표현하는 단계입니다         
아직 처리되지 않은 박스가 있는 동안 이것을 계속 실행합니다         
각각의 박스에 대해 예측값으로 두거나 또는 감지된 물체 중 하나의 예측 위치와 많이 겹쳐서         
높은 IOU를 가지면 이를 버립니다         
이 슬라이드에서는 하나의 물체로만 알고리즘을 설명했습니다         
만약 보행자, 자동차, 오토바이 같은 세 개의 물체를 검출하려 한다면          
결과 벡터는 추가적인 세 개의 요소를 가질 것이고         
각각의 결과 클래스에 대해 독립적으로 세 번의 비-최댓값 억제를 해야 합니다         
