---
layout: post
title: "스트라이드"
tags: [strided convolution, cross correlations]
cateogories: [Convolutional Neural Networks]
---

# 학습 목표
- 스트라이드 합성곱을 배운다.

# 핵심 키워드
- 스트라이드 합성곱
- 교차상관

# 학습내용
- 스트라이드는 필터의 이동 횟수를 뜻합니다. 즉, 기존에 필터가 한칸씩 이동해서 계산했다면, 스트라이드를 주게 되면 그 수만큼 필터가 이동해서 계산하게 됩니다.
- 따라서 최종 크기는 ((n + 2p - f) / n) + 1이 됩니다. 만약에 소수점으로 만들었다면 내림을 하게 됩니다. 보통은 필터에 맞춰서 최대한 크기가 정수가 될수 있도록 패딩과 스트라이드 수치를 맞춥니다.
- 신호처리에서의 교차상관과 합성곱의 관계를 알아봅니다.
  - 일반적으로 수학에서 정의하는 합성곱은 합성곱을 하기 전에 필터를 가로축과 세로축으로 뒤집는 연산을 해줘야합니다.
  - 지금까지 배운 합성곱은 사실 교차상관이지만 딥러닝에서는 관습적으로 합성곱이라고 합니다.
  - 딥러닝에서는 뒤집는 연산을 생략합니다. 이 뒤집는 과정은 신호처리에서는 유용하지만 심층 신경망 분야에서는 아무런 영향이 없기 때문에 생략하게 됩니다.
  
# 스트라이드
![image](https://user-images.githubusercontent.com/50114210/71306694-169e0280-2427-11ea-976e-cf53dce65a53.png)                                         
스트라이드 합성곱은 합성곱 신경망의 기본 구성 요소입니다 예제를 한 번 살펴봅시다              
이 7 x 7 이미지를 3 x 3 필터로 합성곱을 한다고 해봅시다       
일반적인 방법 대신 스트라이드를 2 로 해보죠                          
이게 무슨 뜻이냐면 전과 같이 왼쪽 위의 3 x 3 영역의 요소들의 곱을 계산해서 더해주면 91 이 나오는데                          
여기서 파란 박스를 한 칸이 아닌 두 칸 옮기는 것입니다 이렇게 두 칸 옮기게 되고           
왼쪽 위 부분이 한 점에서 다른 한 점으로 이동하는 것을 잘 살펴봅시다           
그리고 하던 대로 요소들을 곱해서 더해주면 100 이 나오죠             
그리고 또 한 번 파란 박스를 두 칸 옮겨서 계산하면 83 이 나오게 됩니다    
그리고 다음 행으로 갈 때에도 한 칸이 아닌 두 칸을 이동합니다            
파란 박스가 이 쪽으로 이동하게 되고 계산해보면 69 를 얻고               
또 두 칸 이동하면 91 이고 그 다음은 27 그리고 마지막 행은 44, 72, 74 입니다            
이 예시에서는 7 x 7 행렬을 3 x 3 행렬과 합성곱을 해서 3 x 3 행렬을 결과로 얻었습니다            

# 관계식
![image](https://user-images.githubusercontent.com/50114210/71306704-33d2d100-2427-11ea-9341-135668ee821f.png)                  
그래서 입력과 결과의 크기는 다음과 같은 관계식을 가집니다                        
만약 n x n 이미지를 f x f 필터로 합성곱을 하고 p 의 패딩과 스트라이드 s 를 가지면           
이 경우에는 s 는 2 가 되는데 결과의 크기는             
n + 2p - f 에서 이 경우에는 한 번에 s 만큼 이동하기 때문에               
s 로 나누어주고 1을 더해주고 반대도 똑같죠            
이 예시에서는 7 + 0 - 3 / 2 + 1 는 4 / 2 + 1 = 3 입니다              
그래서 3 x 3 행렬이 나오는 것이죠 만약 이 분수꼴이 정수가 아니라면 내림을 해줍니다              
이 표현은 어떤 숫자의 내림값을 의미하죠            
z 의 내림값은 z 보다 작고 z 에 가장 가까운 정수입니다              
이걸 쉽게 이해하려면 이 파란 박스를 계산할 때                    
파란 박스가 패딩을 더한 이미지 안에서 가득 차있을 때만 해주고               
만약 파란 박스의 일부분이 밖으로 빠져나와 있다면 계산을 안해주는 셈이 되죠                
그래서 일반적으로는 3 x 3 필터가 먼저 패딩을 더한 이미지에 딱 맞게 설정한 뒤에 결과를 계산해 줍니다              
그게 관습이죠 그래서 결과의 크기를 계산해 줄 때는 내림해줍니다              
n + 2p - f / s 가 정수가 아닐 때 말이죠             

# 요약
![image](https://user-images.githubusercontent.com/50114210/71306711-40572980-2427-11ea-9107-e39b4e20363f.png)                       
한 번 요약해보면 n x n 이미지를 f x f 필터로 합성곱할 때                   
패딩 p 와 스트라이드 s 가 있을 때 결과 행렬의 크기는 이렇게 됩니다              
이것이 정수가 되도록 각 숫자를 고르는 것이 편하겠지만              
그럴 필요가 없을 때도 있고 또 내림을 할 필요도 없겠죠              
하지만 직접 여러 개의 n, f, p, s 의 값을 가지고 이 식의 결과가 맞는지 확인해 보는 것이 좋습니다                    

# 교차상관
![image](https://user-images.githubusercontent.com/50114210/71306716-54029000-2427-11ea-9597-8ea32a4183ae.png)                               
다음으로 넘어가기 전에 교차상관과 합성곱에 대해 짚어볼 것이 있습니다            
합성곱 신경망을 구현하는데 영향을 주지는 않겠지만 서로 다른 수학책이나 신호 처리 책을 읽을 때              
표현에 있어서 서로 조금 맞지 않는 부분이 있을 수 있습니다            
일반적인 수학책에서 정의하는 합성곱은 요소들을 곱하고 더하는 계산 전에 한 가지 과정이 더 있는데              
6 x 6 행렬과 3 x 3 필터를 합성곱 하기 전에 가로축과 세로축으로 뒤집어 줍니다              
3 x 3 필터를 가로와 세로축으로 미러링 해준 셈이 되는 것이죠             
이렇게 뒤집힌 행렬을 가지고 결과를 계산하게 되면 2 x 7 + 3 x 2 + 7 x 5 이렇게 계속 이어집니다             
이 뒤집힌 행렬을 가지고 4 x 4 결과 행렬의 왼쪽 위 값을 구하는 것이죠                     
이 9 개의 숫자를 계속 한 칸씩 옮겨가며 계산해 줍니다           

# 딥러닝에서의 합성곱             
여기서 정의한 합성곱 연산은 이 미러링 과정을 생략한 것입니다                                     
그래서 지금까지 하고 있던 연산의 과정은 합성곱 대신 교차상관으로 불리지만                
딥러닝에서는 그냥 관습적으로 합성곱이라고 부릅니다            
요약하자면 딥러닝 분야에서는 이런 뒤집는 과정을 생략하고              
사실상 교차상관이라 불리는 것이 맞지만 딥러닝 분야에서는 합성곱이라고 부릅니다             
이 영상에서도 이런 관습을 따를 것이죠                
많은 딥러닝 관련 문헌들을 읽어보면 대부분의 사람들은 뒤집는 과정을 생략한 채로               
이것을 합성곱 연산이라 부릅니다             
그리고 신호 처리나 수학의 특정 분야에서 합성곱에서 뒤집는                
연산을 하는 것이 합성곱 연산이 특수한 성질을 가지게 하는데                 
(A * B) * C = A * (B * C) 가 되고 수학에서는 결합법칙이라고 불립니다               
신호 처리 분야에서는 유용하지만 심층 신경망의 분야에서는 큰 소용이 없기 때문에                 
미러링 과정을 생략하는 것이 코드를 단순화 할 수 있고 신경망의 작동에도 아무런 문제가 없습니다                   
그리고 일반적으로 이것을 합성곱이라고 부르죠                    
수학자들은 교차상관이라고 부르지만 말입니다                                                   
하지만 이것이 프로그래밍에 어떤 영향을 주거나 딥러닝에 대해 이해하는데 어려움을 주지는 않을 것입니다             
