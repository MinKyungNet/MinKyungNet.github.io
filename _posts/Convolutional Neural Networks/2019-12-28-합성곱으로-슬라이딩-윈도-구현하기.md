---
layout: post
title: "합성곱으로 슬라이딩 윈도 구현하기"
tags: [object detection, sliding window detection, convolution]
categories: [Convolutional Neural Networks]
---

# 학습 목표
- 합성곱을 이용하여 슬라이딩 윈도 검출 알고리즘을 구현한다.

# 핵심 키워드
- 물체 인식
- 슬라이딩 윈도 검출
- 합성곱

# 학습 내용
- 기존 합성곱 신경망에서 뒷부분인 완전 연결층을 합성곱층으로 바꾼 것이 sermanet가 2014년에 발표한 논문입니다.
![image](https://user-images.githubusercontent.com/50114210/71540452-4a7ca900-298e-11ea-90a8-ca94629509b6.png)     
- 기존(위)에 것과 비교하면 합성곱층(아래)은 최대 풀링 이후 모든 차원을 1차원으로 만드는 대신, 합성곱 연산을 하게됩니다.
- 이는 수학적으로 완전 연결층 연산과 동일합니다. 결과값으로 도출된 400개의 각 값이 5 * 5 * 16 크기의 필터에 대한 임의의 선형함수를 구성하고 활성화함수를 통과하기 때문입니다.
- 슬라이딩 윈도 검출에서는 아래와 같이 활용합니다.
![image](https://user-images.githubusercontent.com/50114210/71540460-7d26a180-298e-11ea-84cb-f39cefbfc0f7.png)       
- 4개의 윈도를 슬라이딩 하면서 검출하게 된다고 예시를 들어봅니다.
- 마지막을 완전 연결층이 아닌 합성곱 층을 사용하면 아래처럼 4개의 윈도에 해당하는 구역이 생깁니다.
- 이는 합성곱층을 4번 통과하지 않고 한번에 4개의 윈도에 대한 분류를 할 수 있어 계산 비용이 많이 줄어듭니다. 따라서 효율적인 계산을 할 수 있게 됩니다.

# 인트로
지난 글에서 합성곱 신경망을 이용한 슬라이딩 윈도 검출 알고리즘을 배웠습니다      
하지만 이 방법은 너무 느립니다      
이번 강의에서 어떻게 알고리즘을 합성곱을 이용해 구현하는지 보겠습니다      

# FC를 포함한 구조
![image](https://user-images.githubusercontent.com/50114210/71540592-0e4a4800-2990-11ea-86ed-8030bcdd6495.png)              
이것이 무엇을 의미하는지 보도록 하죠 슬라이딩 윈도의 합성곱 구현을 위해         
먼저 어떻게 신경망의 완전 연결 층을  합성곱 층으로 바꾸는지 보도록 하죠         
이 슬라이드에서 먼저  이것에 대해 공부하고         
다음 슬라이드에서는 이 슬라이드에서 배운 것을 이용해         
합성곱의 구현을 보여드리도록 하겠습니다         
물체 인식 알고리즘의 입력으로 14*14*3 이미지를 가진다고 해보죠         
그림으로 표현하기 위해 상당히 작게 설정했습니다         
16개의 5*5 필터를 사용해서 14*14*3을 10*10*16으로 변환 시킵니다         
그리고 2*2 최대 풀링을 수행하면 5*5*16으로 줄어들고         
그러면 400개 유닛에 대한 완전 연결 층이 만들어집니다         
그리고 또 다른 완전 연결 층이 생기고         
마지막으로 소프트 맥스 유닛을 사용하는 출력 y가 나옵니다         
변화를 주기 위해서 약간의 시간이 필요한데요 저는 사진을 약간 변형시겠습니다         
y가 4개의 숫자로 이루어지는 것으로 보겠습니다         
소프트 맥스 유닛의 네 가지 분류인 것이죠         
이 네 개의 분류는 보행자, 자동차, 오토바이, 배경입니다         

# Conv로만 이뤄진 구조
![image](https://user-images.githubusercontent.com/50114210/71540596-1bffcd80-2990-11ea-8185-0844add5e86a.png)                 
이제 이 층들이 어떻게 합성곱 층으로 바뀌는지 보여드리겠습니다           
합성곱 신경망에서  초기 층에 대해서는 동일하게 그려지고           
여기서 다음의 완전 연결 층을 구현하는 방법에 있어서           
5*5 필터를 이용해 400개의 5*5 필터를 사용합니다           
5*5*16 이미지를 사용해 이것을 5*5 필터로 연결시키겠습니다           
5*5 필터는 5*5*16에 맞게  구현되어 있다는 것을 기억하시겠죠           
필터가 모든 16개 채널을 통과할 수 있게 만들어졌었죠           
따라서 여기의 16과 이 부분의 16이 일치하는 것입니다 결국 출력은 1*1이 됩니다            
그리고 400개의 5*5*16 필터를 가지고 있다면           
출력은 1*1*400 의 차원을 가지게 되겠죠           
이 400개를 단지 노드의 집합으로 보기보다는           
우리는 이것을  1*1*400의 볼륨을 가지는 것으로 보도록 하겠습니다           
수학적으로 이것은 완전 연결 층과 동일합니다           
이 400개의 노드가 5*5*16 차원의 필터를 가지고 있으므로           
400개의 각 값이  5*5*16에 대한 임의의 선형 함수이기 때문입니다           
이전 층에 대한 활성을 가집니다           
다음으로 합성곱 층을 구현하기 위해서 1*1 합성곱을 구현할 텐데요           
400개의 1*1 필터가 있다고 하면            
다음 층에서는 400개의 필터가 1*1*400을 만들게 될 것입니다           
따라서 이것이 여기의 완전 연결 층을 의미하는 것이 되죠           
마지막으로 또 다른 1*1 필터를 사용하면 소프트 맥스 활성은 1*1*4 볼륨을 가집니다           
신경망이 출력하는 이 4개의 숫자를 의미하는 것이 됩니다           
이것은 완전 연결 층을 이용해 합성곱 층을 구현하는 과정을 보여줍니다           
이 유닛의 집합은 1*1*400, 1*1*4 볼륨이구현되어 있죠           

# 슬라이딩 윈도우를 포함시키기
![image](https://user-images.githubusercontent.com/50114210/71540607-346fe800-2990-11ea-84d1-816de10023b9.png)               
이렇게 바꾼 후에 어떻게 물체 인식에서 슬라이딩 윈도를 합성곱으로 구현하는지 보겠습니다           
이 슬라이드에서의 설명은 아래에 있는 논문은 참고로 했습니다          
Pierre Sermanet, David Eigen, Xiang Zhang, Michael Mathieu,          
Rob Fergus, Yann LeCun의 논문입니다          
슬라이딩 윈도 합성곱 신경망에 14*14*3 이미지를 입력으로 해보겠습니다          
이 슬라이드에 14*14 와 같이 작은 크기의 숫자를 사용할 것인데요          
숫자와 그림을 조금 간단하게 하기 위해서입니다 이전까지 이런 형태의 신경망이 있었습니다          
소프트 맥스 유닛의 출력으로 1*1*4의 볼륨을 가지게 되었죠          
여기에서는 그림을 간단하게 표시하게 위해서 14*14*3은 실제로는 이런 볼륨을 가지죠          
5*5과 10*10*16도 마찬가지로 이러한 볼륨을 가집니다          
이 슬라이드의 그림을 간단하게 하기 위해서 이 볼륨의 앞부분만 그리도록 하겠습니다          
1*1*400 볼륨을 다 그리는 것 대신 단순하게 1*1 부분만 그리도록 할게요          
이 슬라이드에서는 입체적 부분은 무시하도록 하겠습니다          

# 출력의 위치가 윈도우의 위치
![image](https://user-images.githubusercontent.com/50114210/71540610-3e91e680-2990-11ea-9bb2-163b71b423e9.png)              
합성곱 신경망의 입력이 14*14 또는 14*14*3 이미지라고 하면        
테스트 세트 이미지는 16*16*3이 됩니다        
따라서 이 이미지에 이렇게 노랑색 가장자리를 추가하겠습니다        
본래의 슬라이딩 윈도 알고리즘은 이 파란색 부분을 합성곱 신경망의 입력으로 했습니다        
그리고 0 또는 1의 분류를 만들기 위해 한 번만 이것을 수행했었죠        
이제 이것을 약간 아래로 내려서 2픽셀만큼 이동시켜보겠습니다        
그리고 이번에는 오른쪽으로 2픽셀만큼 이동시키도록 하죠        
이 녹색 사각형을 합성곱 신경망에 입력하고        
그리고 전체적인 합성곱 신경망의 과정을 다시 수행하는 거죠        
그렇게하면 0과 1로 된 또 다른 레이블을 얻게 됩니다 이제 이 오렌지색 영역을        
합성곱 신경망의 입력으로 해서 이것을 한 번 더 수행하면 또 하나의 레이블을 얻습니다        
그리고 마지막으로 가장 아랫 부분을 가지고 한 번 더 수행합니다 이 보라색 사각형 부분이죠        
슬라이딩 윈도 알고리즘에서 이 16*16*3 이미지는 상당히 작은 크기의 이미지입니다        
레이블을 얻기 위해 위의 합성곱 신경망을 4번만 수행하면 되기 때문이죠        
하지만 이것은 이 합성곱 신경망이 많은 반복 계산을 수행하도록 만듭니다        
슬라이딩 윈도의 합성곱 구현이 도움을 주는 것은        
이 네 번의 합성곱 신경망 과정에서 계산들을 공유할 수 있게 해주는 것이죠        
어떻게 하는지 설명해드리도록 하겠습니다        

# 계산을 공유하기
여러분은 이 합성곱 신경망을 이용해 항상 동일한 변수에 대해 계산을 합니다          
동일한 16개의 5*5 필터를 가지고 말이죠 이제 12*12*16 볼륨의 출력이 나올텐데요          
최대 풀링을 수행하면 6*6*16이 나오고          
400번의 5*5필터를 가지고 계산하면2*2*400 볼륨을 얻습니다          
1*1*400 볼륨 대신에 2*2*400 볼륨을 얻게 되었죠          
1*1 필터에 대해 계산을 수행하면 또 다시 1*1*400 대신 2*2*400 볼륨이 결과로 나오고          
이것을 한 번 더 반복하면 1*1*4 대신  2*2*4 볼륨의 출력을 얻습니다          
이 1*1*4짜리 파란색 부분은 외쪽 상단의 14*14 이미지에 대한 결과임을 알 수 있습니다          
여기 오른쪽 윗부분의 1*1*4 볼륨은 여기 오른쪽 상당에 대한 결과이고          
왼쪽 하단은 합성곱 신경망에서 왼쪽 하단의 14*14 영역에 대한 결과이죠          
1*1*4 볼륨의 오른쪽 하단부분은 여기서 오른쪽 하단의 14*14 영역의           
합성곱 신경망에 대한 결과입니다          
이 모든 계산 과정을 거쳤기 때문에 이제 녹색 샘플에 대해서 한번 보도록 하겠습니다          
이 부분을 잘라내서 합성곱 신경망에 통과시키면           
첫 번째 층에서의 활성은 정확이 이 부분이 되겠죠          
다음 층에서 최대 풀링에 대한 활성은 이 영역이 될 것입니다          
그리고 그 다음 층, 다음 층에서는 이렇게 될 것입니다          
이 합성공 신경망의 과정이 수행하고 있는 것은          
네 가지 입력 이미지에 대해서 독립적인 정방향 전파를 수행하는 것 대신          
네 가지 경우를 한 가지 계산으로 통합하는 것입니다          
14*14 이미지의 공통적 영역에 대한 계산을 공유하는 것이죠          

# 더 큰 샘플
![image](https://user-images.githubusercontent.com/50114210/71540619-481b4e80-2990-11ea-8020-1d298ca5e605.png)            
이번엔 더 큰 샘플을 보겠습니다 28*28*3 이미지에 대해 슬라이딩 윈도를 수행하고자 합니다      
동일한 방법으로 정방향 전파를 수행한다면 8*8*4 출력을 얻게 됩니다      
그리고 이것을 14*14 영역에 대해 슬라이딩 윈도를 수행해야 하죠      
첫 번째로는 이 영역에 대해 슬라이딩 윈도를 수행합니다      
이것은 왼쪽 상단 모서리의 이 부분을 출력합니다      
윈도를 이동시키기 위해 두 픽셀 간격을 사용하면      
각 윈도에 대해서 이렇게 수행하게 되겠죠      
첫 번째 행에 대해서 8개의 위치를 가지게 됩니다      
이미지의 아래쪽으로 계속 진행하면 결과적으로 8*8*4 출력을 얻게 됩니다      
2에 대한 최대 풀링 때문에 신경망을 수행하면서       
이미지를 이동시키는데 2픽셀을 사용합니다      

# 자동차 예시
![image](https://user-images.githubusercontent.com/50114210/71540625-536e7a00-2990-11ea-9f6b-75608be41fe6.png)                   
이전에 슬라이딩 윈도를 구현했던 것을 다시 생각해 보죠 먼저 한 영역을 잘라냈죠           
이 부분을 14*14라고 하겠습니다           
이것을 합성곱 신경망에 통과시키고 다음 영역에 대해 동일하게 반복했죠           
다음 14*14 영역에 대해 이것을 반복하고 계속해서 반복합니다           
이 영역이 자동차를 인식할 수 있을 때까지 말이죠           
하지만 이것을 순차적으로 하는 것 대신 이전 슬라이드에서 봤던           
합성곱 신경망을 이용하면 전체 이미지가 28*28 이미지일 때           
합성곱을 사용해서  동시에 모든 예측값을 계산할 수 있습니다           
큰 합성곱 신경망에 한 번만 통과시켜 이 자동차의 위치를 인식할 수 있죠           

# 아웃트로
여기까지 합성곱을 이용해 슬라이딩 윈도를 구현하는 방법이었습니다           
훨씬 효율적인 계산을 할 수 있게 해주죠           
하지만 이 알고리즘은 여전히 한 가지 단점을 가지고 있습니다           
경계 상자의 위치가 정확하지 않을 수 있다는 것입니다.           
