---
layout: post
title: "앵커 박스"
tags: [anchor box, bounding box]
categories: [Convolutional Neural Networks]
---

# 학습 목표
- 앵커 박스에 대해 알아본다.

# 핵심 키워드
- 앵커 박스
- 경계 박스

# 학습 내용
- 현재까지 배운 물체 감지 알고리즘의 최대 단점은 각각의 격자 셀이 오직 하나의 물체만 감지 할 수밖에 없다는 것입니다. 이를 해결하기 위해 앵커 박스를 사용합니다.
- 경계 박스를 직접적으로 예측 하는 대신 미리 크기가 정해진 앵커 박스를 여러 개 만들어 사용합니다.
- 훈련세트의 결과값에도 변화가 있는데, 이전에는 각 격자셀에서 해당 물체에 대한 결과값(물체의 존재 여부, 중심점, 경계 상자 값 그리고 클래스)이 존재했습니다. 그러나 앵커 박스를 사용하게 될 경우, 앵커 박스의 개수만큼 결과값이 늘어나야 합니다.
- 아래 두 가지 예시를 보겠습니다. 물체가 겹쳐있는 경우와 하나만 있는 경우를 살펴보면, 결과값이 이전에 비해 늘어난 것을 알 수 있습니다.
![image](https://user-images.githubusercontent.com/50114210/71545978-2b553a00-29d5-11ea-9ec1-69a3f46b5da8.png)        
![image](https://user-images.githubusercontent.com/50114210/71545982-3314de80-29d5-11ea-8e17-e036e120e96d.png)       
- 두 물체 다 존재하는 경우 두 앵커박스에 해당물체의 존재여부 값은 1이 되며, 각각의 중심값, 경계 상자값, 클래스 값이 존재하게 됩니다.
- 하나의 물체만 존재하는 경우의 이미지는 첫번째 앵커박스에 해당 물체의 존재 여부 값이 0이 되고, 나머지 앵커 1에 해당되는 값들은 임의로 되어도 상관 없습니다.
- 앵커박스는 어떻게 고를까요? 사람이 정할 수도 있고 자동으로 정하는 알고리즘도 있습니다.

# 인트로         
지금껏 본 물체 감지의 문제점 중 하나는          
각각의 격자 셀이 오직 하나의 물체만 감지할 수 있느냐 입니다         
만약 격자 셀이 여러 개의 물체를 감지하고 싶으면 어떻게 할까요?         
앵커 박스를 사용하면 됩니다 예시를 통해 시작해봅시다         

# 바운딩 박스의 중심점이 겹친다면?
![image](https://user-images.githubusercontent.com/50114210/71546138-14174c00-29d7-11ea-91c5-107750a792f2.png)          
3×3 격자를 가지는 이런 이미지가 있다고 해봅시다             
보행자와 자동차의 중심점이 거의 같은 위치에 있고 둘 다 같은 격자 셀 안에 있습니다             
그 격자 셀에 대해서 Y가 보행자, 자동차, 오토바이의 세 클래스를 감지하는 벡터를 도출한다고 하면             
두 개의 감지 모두 출력하는 것은 불가능하므로 둘 중 하나의 감지만 골라서 출력해야 합니다             
앵커 박스 아이디어를 가지고 할 것은 다음과 같습니다             
앵커 박스 또는 앵커 박스 모양이라고 불리는 두 개의 다른 모양을 가지고 할 일은             
두 개 또는 일반적으로 더 많은 앵커 박스로 두 예측을 결합합니다             
아마 다섯 개 또는 더 많을 수도 있지만              
이 영상에서는 설명을 쉽게 하기 위해두 개의 앵커 박스만 사용하겠습니다             
여러분이 할 일은 비용 레이블을 정의해서              
왼쪽의 벡터 대신 기본적으로 이것을 두 번 반복합니다             
그래서 pc, bx, by, bw c1, c2, c3를 가지게 되고              
이것들은 앵커 박스 1과 관련된 여덟 개의 결과값입니다             
그리고 pc, bx부터 c1, c2, c3까지를 반복합니다              
앵커 박스 2과 관련된 또 다른 여덟 개의 결과값입니다             
보행자의 모양이 앵커 박스 2보다 앵커 박스 1과 더 비슷하기 때문에             
이 여덟 개의 숫자를 사용해서 부호화 합니다             
Pc는 여기에 보행자가 있다는 것이고 이것들을 이용해서              
보행자를 둘러싼 박스를 부호화하고 물체가 보행자라는 것을 부호화합니다             
그리고 자동차를 둘러싼 박스는 앵커 박스 1보다 앵커 박스 2의 모양과 더 비슷하기 때문에             
이것들을 사용해서 두 번째 물체는 자동차라는 것과             
감지된 자동차에 관련된 경계 상자와 매개변수들을 부호화합니다             

# 앵커박스 요약
![image](https://user-images.githubusercontent.com/50114210/71546143-21343b00-29d7-11ea-85b6-a14f1965ddcf.png)                   
요약하겠습니다 앵커 박스를 사용하기 전에는          
훈련 세트 사진에 있는 각 물체들은 물체의 중심점이 있는 격자 셀에 배정되었습니다          
결과값 y는 3×3×8입니다 3×3 격자를 사용하고 각 격자에 대한 결과 벡터로          
pc와 경계 상자 그리고 c1, c2, c3를 가지기 때문입니다          
앵커 박스를 가지고는 다음과 같이 합니다           
각 물체는 이전과 같이 중심점이 있는 셀에 배정됩니다          
하지만 이제는 물체의 모양과 가장 높은 IOU를 가지는 격자 셀과 앵커 박스에 배정됩니다          
그러니까 두 개의 앵커박스가 있으면 하나의 물체를 골라서 만약 이런 모양의 물체가 있다면          
두 개의 앵커 박스를 가지고 앵커 박스 1은 이런 모양이고           
앵커 박스 2는 이런 모양이라고 합시다          
두 앵커 박스 중 어느 것이 참 값 경계 상자에 대해 더 높은 IOU를 가지는지 확인하고          
그게 어떤 것이든 간에 그 물체는 격자 셀에만 배정된 것이 아니라          
격자 셀, 앵커 박스의 쌍에 배정된 것입니다          
이게 물체가 타깃 레이블에 부호화 된 방식입니다 결과값 y는 3×3×16입니다          
이전 슬라이드에서 보신 것처럼 y는 이제 16차원입니다          
또는 3×3×2×8로 생각할 수도 있습니다           
이제 두 개의 앵커 박스가 있고 y는 8차원이기 때문입니다          
y가 8차원인 이유는 세 개의 물체 클래스가 있기 때문입니다          
만약 더 많은 물체가 있다면 y의 차원도 더 커집니다          

# 예시
![image](https://user-images.githubusercontent.com/50114210/71546148-2ee9c080-29d7-11ea-89f2-0b97f0b750df.png)          
이제 구체적인예시를 봅시다 이 격자 셀에 대해서 y가 무엇인지 구체화해봅시다          
보행자는 앵커 박스 1의 모양과 더 비슷하기 때문에           
보행자에게 이 벡터의 위쪽 절반을 할당합니다          
어떤 물체가 여기 존재하고 보행자와 관련된 어떤 경계 상자가 있고          
만약 보행자의 클래스가 1이라면 1 0 0이 됩니다          
자동차의 모양은 앵커 박스 2와 더 비슷하기 때문에          
벡터의 나머지 부분은 1 그리고 자동차와 관련된 경계 상자          
그리고 자동차는 c2니까 0 1 0이 됩니다          
이게 화살표로 표시한 가운데 아래 격자 셀의 레이블 y입니다          
만약 이 격자 셀이 보행자 없이 자동차만 가졌다면 어떨까요?          
자동차만 있어도 자동차를 둘러싼 경계 상자의 모양은 여전히 앵커 박스 2와 비슷합니다          
보행자 없이 자동차만 있는 경우의 레이블 y는 앵커 박스 2의 요소들에 대해서는 똑같습니다          
벡터의 이 부분은 앵커 박스 2에 대한 것입니다          
앵커 박스 1의 요소들에 대해서는 물체가 없다는 것을 표현하기 위해 Pc는 0          
그리고 나머지 부분들은 아직 신경 쓰지 않겠습니다          

# 앵커박스 수 이상의 물체가 겹친다면?
추가적인 세부사항으로 만약 두 개의 앵커 박스가 있는데 세 개의 물체가 한 격자 셀에 있다면?          
이건 이 알고리즘이 다루지 않는 한 가지 경우입니다          
이런 일이 일어나지 않기를 바라지만 만약 일어난다면          
이 알고리즘으로는 그것을 다룰 좋은 방법이 없습니다          
단지 그 경우에 대한 어떤 기본 승자 결정을 구현합니다          
두 물체가 같은 격자 셀에 연관되고 같은 앵커 박스를 갖는 경우는 어떨까요?          
그건 이 알고리즘이 다루지 않는 또 한 가지 경우입니다          
만약 데이터 세트에서 이런 일이 발생하지 않도록           
승부 결정 방식을 구현한다면 성능에 큰 영향을 주지 않을 겁니다          

# 앵커박스의 이점
이게 앵커 박스에 대한 전부입니다         
앵커 박스는 두 물체가 한 격자 셀에 나타날 경우를 다루는 방법입니다         
실제로는 3×3 격자 대신 19×19 격자를 사용하면 아주 드물게 발생합니다         
361개의 격자 셀에서 두 물체가 같은 중심점을 가질 확률은          
일어날 수는 있지만 자주 발생하지는 않습니다         
앵커 박스가 주는 더 좋은 결과는 여러분의 학습 알고리즘을 더 전문화시킵니다         
특히 데이터 세트에 보행자 같은 길쭉한 물체가 있거나         
자동차 같은 넓은 물체가 있는 경우          
이건 여러분의 학습 알고리즘이 자동차 같은 넓은 물체를 감지하거나          
보행자 같은 길쭉한 물체를 감지하는 데에 특화되게 합니다         

# 앵커박스 선택
마지막으로 앵커 박스를 어떻게 고를까요?             
사람들이 손수 감지할 물체의 다양한 모양을 커버할 5개 또는 10개의 앵커 박스를 고를까요?             
머신 러닝에 다른 심화 지식을 가진 분들을 위해 언급하자면             
나중에 더 심화된 버전의 YOLO  논문에서 이것을 하는 방식은             
K-평균 알고리즘을 사용해서 얻을 것으로 생각되는 두 가지 물체 모양을 그룹 짓는 것입니다             
이것들을 사용해서 앵커 박스 세트를 고르면              
이것이 여러분이 감지할 많은 물체들의 가장 정형화된 표현입니다             
하지만 자동적으로 앵커 박스를 고르는 심화적인 방식들이 있습니다             
만약 직접 고른다면 쉽게 발견할 것으로 예상되는             
길쭉하거나 넓은 물체 모양을 아우르는 집합을 골라야 할 것입니다             
