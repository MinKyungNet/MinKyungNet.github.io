---
layout: post
title: "입체형 이미지에서의 합성곱"
tags: [convolution, channel, filter]
categories: [Convolutional Neural Networks]
---

# 학습 목표
- 입체형 이미지에서 합성곱을 배운다.

# 핵심 키워드
- 합성곱
- 채널
- 필터

# 학습 내용
- 이미지에 색상(RGB)이 들어가면 입체형으로 변하게 되며, 차원이 하나 증가하게 됩니다.
- 즉 (높이 * 넓이 * 채널)로 변하게 되는데, 채널은 색상 또는 입체형 이미지의 깊이를 뜻합니다.
- 이에 따라 합성곱에 사용되는 하나의 필터도 각 채널 별로 하나씩 증가하게 됩니다.

![image](https://user-images.githubusercontent.com/50114210/71371244-dfc91780-25f3-11ea-9945-225a751809e6.png)           

- 입체 이미지의 합성곱 계산은 모든 채널의 합성곱 연산을 더해주는 형식으로 위 그림과 같습니다.
- 각 채널별로 필터는 모두 같은 것을 사용할 수도 있고 다른 것을 사용할 수도 있습니다.
- 패딩과 스트라이드가 없다고 가정했을때, 최종 출력으로 (n * n * nc) * (f * f * nc) = (n - f + 1) * (n - f + 1) * nc' 형태가 됩니다.
  - n : 이미지의 크기
  - nc : 채널의 개수
  - f : 필터의 크기
  - nc' : 사용된 필터의 개수
  
# 인트로
지금까지는 2D 이미지에서 합성곱의 방식을 배웠는데             
이번에는 2D 이미지 뿐만 아니라 3D 입체형의 합성곱을 알아봅시다                                  

# 3D 합성곱이란?
![image](https://user-images.githubusercontent.com/50114210/71371741-8530bb00-25f5-11ea-9270-d334bcf8c761.png)             
먼저 예시를 살펴봅시다 만약 살펴볼 이미지가 흑백이 아닌 RGB 이미지라면                
6 x 6 이미지가 아닌 6 x 6 x 3 로 볼 수 있는데 여기에서 3 은 세 개의 색상 채널에 해당합니다              
그래서 이것을 세 개의 6 x 6 이미지 더미라고 볼 수도 있죠              
윤곽선 검출이나 이 이미지의 다른 특성들을 알아보려면 이전의 3 x 3 필터 대신             
3D 필터를 사용해야 하는데 3 x 3 x 3 의 크기를 가질 것이고              
필터 자신도 빨강, 초록, 파랑에 해당하는 세 개의 층을 가지게 될 것입니다             
각각의 이름을 더해주자면 여기에 있는 이 6 은 높이고 이것이 넓이고 3 은 채널의 수 입니다             
그리고 필터도 마찬가지로 높이와 넓이와 채널의 수를 가집니다            
그리고 이미지의 채널 수는 필터의 채널 수와 일치해야 하죠                    
그래서 이 두 숫자가 반드시 같아야 합니다          
다음 슬라이드에서 이 합성곱이 어떻게 실행되는지 볼 것인데 결과 이미지는 4 x 4 입니다         
정확히는 4 x 4 x 1 이고 더 이상 뒤에 3 이 없습니다              

# 3D 합성곱 방식
![image](https://user-images.githubusercontent.com/50114210/71371784-a85b6a80-25f5-11ea-818d-2348b9b88505.png)              
여기 6 x 6 x 3 이미지가 있고 여기는 3 x 3 x 3 필터가 있고              
그리고 이미지와 필터 크기의 마지막 숫자가 일치합니다              
이 세 개의 행렬을 쌓은 것 같이 생긴 3 x 3 x 3 필터를 단순화시켜서              
삼차원의 정육면체로 나타낼 수 있습니다 이 합성곱 연산의 결과를 계산하기 위해서는               
먼저 이 3 x 3 x 3 필터를 왼쪽 위에 위치하게 만들어줘야 합니다              
그리고 3 x 3 x 3 필터는 27 개의 숫자가 있습니다 3 의 세제곱은 27 이죠              
그리고 이 각각의 숫자를 빨강, 초록, 파랑 채널에 해당하는 수와 곱해줍니다              
그래서 빨간색 채널의 9 개의 숫자와 곱해주고              
또 초록색 채널과 그 밑의 파란색 채널의 숫자들을              
이 노란 정육면체의 해당하는 27 개의 숫자와 곱해주고 더해줍니다              
이것으로 결과 이미지의 첫 숫자를 얻을 수 있습니다                       
그리고 다음 값을 얻기 위해서는 이 정육면체를 한 칸 옮겨서                       
다시 27 개의 숫자를 각각 곱해준 것을 더해주면 다음 값을 구할 수 있습니다                       
그 다음 위치에서 또 계산하면 세 번째 값을 알 수 있고                       
여기가 마지막 값에 해당하는 위치입니다                       

# 3D 합성곱 예제
![image](https://user-images.githubusercontent.com/50114210/71371800-bdd09480-25f5-11ea-8070-11ac7e61fe16.png)              
이것으로 무엇을 할 수 있을까요                       
여기 예시가 있는데 이 필터는 3 x 3 x 3 의 크기를 가집니다                       
그리고 빨간색 채널의 윤곽선을 검출하려 한다면                       
첫 번째 필터는 1 1 1 -1 -1 -1 이 될 것이고                        
그리고 초록색 채널 부분은 모두 0 이 되고 파란색 채널도 전부 0 이 됩니다                       
이 세 가지가 합쳐져서 3 x 3 x 3 필터를 이루게 된다면                       
빨간색 채널의 세로 윤곽선을 검출하게 될 것입니다                       
또는 만약 세로 수평선이 어떤 색이던 관계 없다면 이런 필터를 사용하면 됩니다                       
세 채널 모두에 1 1 1 -1 -1 -1 이 있으면 되죠                       
두 번째 방식으로 숫자를 설정하면 모든 색의 윤곽선을 검출하는                       
3 x 3 x 3 윤곽선 검출기가 되고 이 숫자에 다른 값을 넣음으로써                       
다른 특성들을 검출할 수도 있습니다                       
컴퓨터 비전의 분야에서는 일반적으로 입력 이미지가                       
특정한 높이와 넓이와 특정한 수의 채널을 가지게 되면                       
필터의 높이와 넓이는 다르지만 동일한 수의 채널을 가져야하고                       
이론적으로 하나의 필터가 빨간색이나 초록색 또는 파란색의 채널 단 하나만 보는 것도 가능합니다                       
그래서 6 x 6 x 3 의 이미지를 3 x 3 x 3 과 합성곱을 하면 2D 의 4 x 4 결과 이미지를 얻게 됩니다                       

# 여러개의 필터
![image](https://user-images.githubusercontent.com/50114210/71371827-db056300-25f5-11ea-8c21-fdf0a4ddbce5.png)              
이제 입체형에서 어떻게 합성곱 연산을 하는지 알게 되었고                             
마지막으로 합성곱 신경망의 중요한 구성 요소인 개념이 있는데                             
만약 세로 윤곽선만 찾으려는 것이 아니라 세로와 가로 윤곽선 모두거나                             
45도 혹은 70도 기울어진 윤곽선일 수도 있습니다                             
다시 말해 여러 개의 필터를 동시에 사용하는 것 말이죠                             
여기 전 슬라이드의 그림이 있는데 6 x 6 x 3 이미지가 여기 전 슬라이드의 그림이                             
있는데 6 x 6 x 3 이미지가 3 x 3 x 3 와 합성곱하여 4 x 4 의 결과를 얻는데                             
이것이 어쩌면 세로 윤곽선이나 다른 어떤 검출기일 수 있습니다                             
여기 두 번째 오렌지색 필터를 가로 윤곽선 검출기라 해봅시다                             
첫 번째 필터와의 합성곱은 4 x 4 의 결과를 내놓고                             
두 번째 필터와의 합성곱은 또 다른 4 x 4 의 결과를 내놓습니다                             
그리고 이 두 4 x 4 이미지에서 첫 번째를 앞 쪽에 두고                              
두 번째 필터의 결과를 그 뒤에 놓습니다                             
그래서 두 개를 쌓게 되면 4 x 4 x 2 의 크기가 되죠                             
입체형을 상자를 그린다고 생각하면 됩니다                             
아마 이렇게 생겼을 것이고 4 x 4 x 2 의 부피를 가질 것입니다                             
6 x 6 x 3 의 이미지를 두 개의 3 x 3 x 3 필터와 합성곱한 결과로                             
두 개의 4 x 4 행렬을 얻고 둘을 합쳐서 4 x 4 x 2 의                             
부피를 얻게 되고 여기서 2 는 두 개의 필터를 의미합니다                             

# 요약
![image](https://user-images.githubusercontent.com/50114210/71371845-eeb0c980-25f5-11ea-8100-df08dbfd27e9.png)            
그래서 요약해보면 만약 n x n x 채널의 수 의 크기를 가진 입력 이미지가 있다면                             
예시에서는 6 x 6 x 3 을 사용했는데 n 의 아래첨자에 C 는 채널의 수를 의미하고                             
f x f 와 동일한 채널의 수를 사용해서 3 x 3 x 3 이 되었습니다                             
그리고 일반적으로 이것과 이것은 같은 숫자여야 합니다                             
그래서 결과는 n－f＋1 × n－f＋1 × nc' 인데 nc' 는 사용한 필터의 개수입니다                             
이 예시에서는 4 x 4 x 2 였죠 여기서 가정은 1 의 스트라이드와 패딩이 없다는 것입니다                             
만약 다른 스트라이드나 패딩을 사용한다면                             
이 n - f + 1 이 이전 영상에서 본 것처럼 바뀔 것입니다                             
그래서 입체형에서의 합성곱은 매우 효과적입니다                             
세 채널의 RGB 이미지에 적용 가능하다는 점은 극히 일부분이고                             
더 중요한 것은 가로와 세로 윤곽선처럼 두 개의 특성 또는 10 개                             
128개 혹은 수 백개의 특성들을 검출할 수 있고 그 결과는                             
검출하고자 하는 특성의 수만큼 채널을 가지게 될 것입니다                             
                             
# 채널 vs 깊이
![image](https://user-images.githubusercontent.com/50114210/71371859-012b0300-25f6-11ea-9644-b8a69eb9239f.png)           
그리고 용어에 대해서 짚고 넘어가자면 여기서 채널의 수는            
마지막 크기를 나타내고 3D 입체형의 깊이라고 불리기도 합니다            
채널과 깊이 모두 자주 사용되는 용어지만            
신경망의 깊이 때문에 깊이라는 표현이 혼란을 줄 수 있습니다            
그래서 이 영상에서는 채널이라는 표현이 필터의 마지막 크기를 나타내는데 쓰였죠            
